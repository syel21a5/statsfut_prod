{% extends 'base.html' %}
{% load static %}
{% load matches_extras %}
{% load flag_tags %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-white fw-bold mb-0">
                {% if team.logo %}
                <img src="{{ team.logo }}" alt="{{ team.name }}" style="height: 40px; margin-right: 10px;">
                {% else %}
                <img src="{{ team.league.country|country_en|get_flag_url }}" alt="{{ team.league.country|country_en }}" style="height: 30px; margin-right: 10px;">
                {% endif %}
                {{ team.name }}
            </h2>
            <p class="text-secondary mb-0 mt-1">
                <span class="text-info">{{ league.name }}</span> <i class="fa-solid fa-chevron-right mx-2 small"></i> Team Stats
            </p>
        </div>
        <a href="{% url 'matches:league_goals' league_name=league.name|slugify %}" class="btn btn-outline-secondary btn-sm">
            <i class="fa-solid fa-arrow-left me-1"></i> Back to League
        </a>
    </div>

    <!-- Top Row: Latest & Upcoming Matches -->
    <div class="row g-4 mb-4">
        <!-- Latest Matches -->
        <div class="col-lg-6">
            <div class="card border-0 bg-white bg-opacity-10 text-white shadow-sm h-100">
                <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 py-2">
                    <h6 class="mb-0 fw-bold small text-uppercase">Latest Matches</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-dark table-sm mb-0 text-center small align-middle">
                            <thead class="sticky-top bg-dark">
                                <tr class="text-secondary">
                                    <th>Date</th>
                                    <th class="text-end">Home</th>
                                    <th>Score</th>
                                    <th class="text-start">Away</th>
                                    <th>H2H</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for m in matches_list %}
                                <tr>
                                    <td class="text-secondary">{{ m.date|date:"j M" }}</td>
                                    <td class="text-end {% if m.is_home %}fw-bold text-white{% else %}text-secondary{% endif %}">
                                        {% if m.is_home %}{{ team.name }}{% else %}{{ m.opponent.name }}{% endif %}
                                    </td>
                                    <td>
                                        <span class="badge {% if m.result == 'W' %}bg-success{% elif m.result == 'L' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                                            {{ m.score }}
                                        </span>
                                    </td>
                                    <td class="text-start {% if not m.is_home %}fw-bold text-white{% else %}text-secondary{% endif %}">
                                        {% if m.is_home %}{{ m.opponent.name }}{% else %}{{ team.name }}{% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'matches:h2h_detail' league_name=league.name|slugify team1_name=team.name|slugify team2_name=m.opponent.name|slugify %}" class="btn btn-xs btn-outline-info py-0 px-1" style="font-size: 0.7rem;">H2H</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upcoming Matches -->
        <div class="col-lg-6">
            <div class="card border-0 bg-white bg-opacity-10 text-white shadow-sm h-100">
                <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 py-2">
                    <h6 class="mb-0 fw-bold small text-uppercase">Upcoming Matches</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        {% if upcoming_matches %}
                        <table class="table table-dark table-sm mb-0 text-center small align-middle">
                            <thead class="sticky-top bg-dark">
                                <tr class="text-secondary">
                                    <th>Date</th>
                                    <th class="text-end">Home</th>
                                    <th>vs</th>
                                    <th class="text-start">Away</th>
                                    <th>H2H</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for m in upcoming_matches %}
                                <tr>
                                    <td class="text-secondary">{{ m.date|date:"j M" }}</td>
                                    <td class="text-end {% if m.home_team == team %}fw-bold text-white{% else %}text-secondary{% endif %}">
                                        {{ m.home_team.name }}
                                    </td>
                                    <td class="text-muted">vs</td>
                                    <td class="text-start {% if m.away_team == team %}fw-bold text-white{% else %}text-secondary{% endif %}">
                                        {{ m.away_team.name }}
                                    </td>
                                    <td>
                                        {% with opp=m.away_team|default:m.home_team %}
                                            {% if m.home_team == team %}
                                                {% with opponent=m.away_team %}
                                                <a href="{% url 'matches:h2h_detail' league_name=league.name|slugify team1_name=team.name|slugify team2_name=opponent.name|slugify %}" class="btn btn-xs btn-outline-info py-0 px-1" style="font-size: 0.7rem;">H2H</a>
                                                {% endwith %}
                                            {% else %}
                                                {% with opponent=m.home_team %}
                                                <a href="{% url 'matches:h2h_detail' league_name=league.name|slugify team1_name=team.name|slugify team2_name=opponent.name|slugify %}" class="btn btn-xs btn-outline-info py-0 px-1" style="font-size: 0.7rem;">H2H</a>
                                                {% endwith %}
                                            {% endif %}
                                        {% endwith %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div class="p-4 text-center text-secondary">
                            <i class="fa-regular fa-calendar-xmark fa-2x mb-2"></i>
                            <p class="mb-0">No upcoming matches scheduled.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- LEFT COLUMN (Main Stats) -->
        <div class="col-lg-8">
            
            <!-- 1. Seasonal Match Statistics -->
            <div class="card border-0 bg-white bg-opacity-10 text-white shadow-sm mb-4">
                <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 py-2">
                    <h6 class="mb-0 fw-bold small text-uppercase">Seasonal Match Statistics</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-sm mb-0 text-center small">
                            <thead>
                                <tr class="text-secondary">
                                    <th></th>
                                    <th>GP</th>
                                    <th>W</th>
                                    <th>D</th>
                                    <th>L</th>
                                    <th>W%</th>
                                    <th>D%</th>
                                    <th>L%</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for c in cats %}
                                <tr class="{% if c == 'total' %}bg-white bg-opacity-10 fw-bold{% endif %}">
                                    <td class="text-start ps-3 text-secondary text-capitalize">{{ c }}</td>
                                    <td>{{ stats|get_item:c|get_item:'gp' }}</td>
                                    <td class="text-success">{{ stats|get_item:c|get_item:'w' }}</td>
                                    <td class="text-warning">{{ stats|get_item:c|get_item:'d' }}</td>
                                    <td class="text-danger">{{ stats|get_item:c|get_item:'l' }}</td>
                                    <td>
                                        <div class="progress" style="height: 6px; width: 60px; margin: 0 auto;">
                                            <div class="progress-bar bg-success" role="progressbar" style="--w-pct: {{ stats|get_item:c|get_item:'w_pct' }}%; width: var(--w-pct);"></div>
                                        </div>
                                        <span style="font-size: 0.7rem;">{{ stats|get_item:c|get_item:'w_pct'|floatformat:0 }}%</span>
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 6px; width: 60px; margin: 0 auto;">
                                            <div class="progress-bar bg-warning" role="progressbar" style="--d-pct: {{ stats|get_item:c|get_item:'d_pct' }}%; width: var(--d-pct);"></div>
                                        </div>
                                        <span style="font-size: 0.7rem;">{{ stats|get_item:c|get_item:'d_pct'|floatformat:0 }}%</span>
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 6px; width: 60px; margin: 0 auto;">
                                            <div class="progress-bar bg-danger" role="progressbar" style="--l-pct: {{ stats|get_item:c|get_item:'l_pct' }}%; width: var(--l-pct);"></div>
                                        </div>
                                        <span style="font-size: 0.7rem;">{{ stats|get_item:c|get_item:'l_pct'|floatformat:0 }}%</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <!-- PPG Bars -->
                    <div class="p-3 border-top border-secondary border-opacity-25">
                        <div class="d-flex align-items-center mb-2 small">
                            <div style="width: 100px;" class="text-secondary">PPG (Home):</div>
                            <div class="flex-grow-1 mx-2 bg-secondary bg-opacity-25 rounded-pill" style="height: 6px;">
                                <div class="bg-info rounded-pill" style="--ppg-home: {% widthratio stats.home.ppg 3 100 %}%; width: var(--ppg-home); height: 100%;"></div>
                            </div>
                            <div class="fw-bold" style="width: 40px; text-align: right;">{{ stats.home.ppg|floatformat:2 }}</div>
                        </div>
                        <div class="d-flex align-items-center mb-2 small">
                            <div style="width: 100px;" class="text-secondary">PPG (Away):</div>
                            <div class="flex-grow-1 mx-2 bg-secondary bg-opacity-25 rounded-pill" style="height: 6px;">
                                <div class="bg-info rounded-pill" style="--ppg-away: {% widthratio stats.away.ppg 3 100 %}%; width: var(--ppg-away); height: 100%;"></div>
                            </div>
                            <div class="fw-bold" style="width: 40px; text-align: right;">{{ stats.away.ppg|floatformat:2 }}</div>
                        </div>
                         <div class="d-flex align-items-center mb-2 small">
                            <div style="width: 100px;" class="text-secondary fw-bold">PPG (Total):</div>
                            <div class="flex-grow-1 mx-2 bg-secondary bg-opacity-25 rounded-pill" style="height: 8px;">
                                <div class="bg-primary rounded-pill" style="--ppg-total: {% widthratio stats.total.ppg 3 100 %}%; width: var(--ppg-total); height: 100%;"></div>
                            </div>
                            <div class="fw-bold" style="width: 40px; text-align: right;">{{ stats.total.ppg|floatformat:2 }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Relative Form -->
            <div class="card border-0 bg-white bg-opacity-10 text-white shadow-sm mb-4">
                <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 py-2">
                    <h6 class="mb-0 fw-bold small text-uppercase">Relative Form</h6>
                </div>
                <div class="card-body p-0">
                     <table class="table table-dark table-sm mb-0 text-center small">
                        <thead>
                            <tr class="text-secondary">
                                <th></th>
                                <th>All</th>
                                <th>Last 8</th>
                                <th>Diff</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="text-start ps-3 text-secondary">Points per Game</td>
                                <td>{{ relative_form.ppg.all }}</td>
                                <td class="text-info fw-bold">{{ relative_form.ppg.l8 }}</td>
                                <td class="{% if relative_form.ppg.diff > 0 %}text-success{% elif relative_form.ppg.diff < 0 %}text-danger{% endif %} fw-bold">
                                    {% if relative_form.ppg.diff > 0 %}+{% endif %}{{ relative_form.ppg.diff }}%
                                </td>
                            </tr>
                             <tr>
                                <td class="text-start ps-3 text-secondary">AVG Goals For</td>
                                <td>{{ relative_form.avg_gf.all }}</td>
                                <td class="text-info fw-bold">{{ relative_form.avg_gf.l8 }}</td>
                                <td class="{% if relative_form.avg_gf.diff > 0 %}text-success{% elif relative_form.avg_gf.diff < 0 %}text-danger{% endif %} fw-bold">
                                    {% if relative_form.avg_gf.diff > 0 %}+{% endif %}{{ relative_form.avg_gf.diff }}%
                                </td>
                            </tr>
                            <tr>
                                <td class="text-start ps-3 text-secondary">AVG Goals Against</td>
                                <td>{{ relative_form.avg_ga.all }}</td>
                                <td class="text-info fw-bold">{{ relative_form.avg_ga.l8 }}</td>
                                <td class="{% if relative_form.avg_ga.diff > 0 %}text-danger{% elif relative_form.avg_ga.diff < 0 %}text-success{% endif %} fw-bold">
                                    {% if relative_form.avg_ga.diff > 0 %}+{% endif %}{{ relative_form.avg_ga.diff }}%
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 3. No Goal Scored / Conceded -->
            <div class="card border-0 bg-white bg-opacity-10 text-white shadow-sm mb-4">
                <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 py-2">
                    <h6 class="mb-0 fw-bold small text-uppercase">Clean Sheets & Failure to Score</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-dark table-sm mb-0 text-center small">
                        <thead>
                            <tr class="text-secondary">
                                <th></th>
                                <th>Home</th>
                                <th>Away</th>
                                <th>All</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="text-start ps-3 text-success">Clean Sheets</td>
                                <td>{{ rates.home.cs_pct }}%</td>
                                <td>{{ rates.away.cs_pct }}%</td>
                                <td>{{ rates.total.cs_pct }}%</td>
                            </tr>
                            <tr>
                                <td class="text-start ps-3 text-info">Both Teams Scored</td>
                                <td>{{ rates.home.bts_pct }}%</td>
                                <td>{{ rates.away.bts_pct }}%</td>
                                <td>{{ rates.total.bts_pct }}%</td>
                            </tr>
                            <tr>
                                <td class="text-start ps-3 text-success">Won-to-Nil</td>
                                <td>{{ rates.home.wtn_pct }}%</td>
                                <td>{{ rates.away.wtn_pct }}%</td>
                                <td>{{ rates.total.wtn_pct }}%</td>
                            </tr>
                            <tr>
                                <td class="text-start ps-3 text-warning">Failed to Score</td>
                                <td>{{ rates.home.fts_pct }}%</td>
                                <td>{{ rates.away.fts_pct }}%</td>
                                <td>{{ rates.total.fts_pct }}%</td>
                            </tr>
                            <tr>
                                <td class="text-start ps-3 text-danger">Lost-to-Nil</td>
                                <td>{{ rates.home.ltn_pct }}%</td>
                                <td>{{ rates.away.ltn_pct }}%</td>
                                <td>{{ rates.total.ltn_pct }}%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 4. Progression Chart -->
            <div class="card border-0 bg-white bg-opacity-10 text-white shadow-sm mb-4">
                <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 py-2">
                    <h6 class="mb-0 fw-bold small text-uppercase">{{ team.name }}'s Progression</h6>
                </div>
                <div class="card-body p-3">
                    <div style="height: 200px;">
                        <canvas id="progressionChart" data-chart='{{ chart_data_json|safe }}'></canvas>
                    </div>
                    <div class="d-flex justify-content-center gap-3 mt-2 small">
                        <span class="text-success"><i class="fa-solid fa-circle small"></i> Win (+2)</span>
                        <span class="text-warning"><i class="fa-solid fa-circle small"></i> Draw (0)</span>
                        <span class="text-danger"><i class="fa-solid fa-circle small"></i> Loss (-1)</span>
                    </div>
                </div>
            </div>

            <!-- 5. Comparison with League Average -->
            <div class="card border-0 bg-white bg-opacity-10 text-white shadow-sm mb-4">
                <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 py-2">
                    <h6 class="mb-0 fw-bold small text-uppercase">Comparison with League Average</h6>
                </div>
                <div class="card-body p-0">
                    <!-- Tabs -->
                    <ul class="nav nav-tabs nav-fill border-secondary border-opacity-25" id="comparisonTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active text-white bg-transparent" id="comp-total-tab" data-bs-toggle="tab" data-bs-target="#comp-total" type="button" role="tab">Total</button>
                        </li>
                         <li class="nav-item" role="presentation">
                            <button class="nav-link text-white bg-transparent" id="comp-home-tab" data-bs-toggle="tab" data-bs-target="#comp-home" type="button" role="tab">Home</button>
                        </li>
                         <li class="nav-item" role="presentation">
                            <button class="nav-link text-white bg-transparent" id="comp-away-tab" data-bs-toggle="tab" data-bs-target="#comp-away" type="button" role="tab">Away</button>
                        </li>
                    </ul>
                    <div class="tab-content p-0" id="comparisonTabContent">
                        {% for cat in cats %}
                             <!-- Note: Implementing tabs via JS logic inside the loop or repeating the loop inside tabs. 
                                  To keep it simple, I will assume we can just list the stats. 
                                  Actually, the original had tabs for Total/Home/Away but the content was similar. 
                                  I will just show TOTAL here for brevity or implement a simple toggle if needed.
                                  Let's stick to showing Total for now or use the loop variable 'cat' effectively. 
                                  Wait, 'cats' is ['total', 'home', 'away']. Ah! So I should loop through 'cats' and create tab panes.
                             -->
                        {% endfor %}
                        
                        {% for c in cats %}
                        <div class="tab-pane fade {% if c == 'total' %}show active{% endif %}" id="comp-{{ c }}" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-sm mb-0 small align-middle">
                                    <thead>
                                        <tr class="text-secondary text-center">
                                            <th class="text-start ps-3">Stat</th>
                                            <th>{{ team.name }}</th>
                                            <th>League Avg</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Wins -->
                                        <tr>
                                            <td class="text-start ps-3">% Wins</td>
                                            <td class="text-center"><span class="badge bg-success">{{ stats|get_item:c|get_item:'win_pct' }}%</span></td>
                                            <td class="text-center text-secondary">{{ league_avg|get_item:c|get_item:'win_pct'|floatformat:0 }}%</td>
                                        </tr>
                                        <tr>
                                            <td colspan="3" class="px-3 pb-2 pt-0">
                                                <div class="progress" style="height: 4px;">
                                                    <div class="progress-bar bg-success" style="--win-pct: {{ stats|get_item:c|get_item:'win_pct' }}%; width: var(--win-pct);"></div>
                                                    <div class="progress-bar bg-secondary opacity-25" style="--league-win-pct: {{ league_avg|get_item:c|get_item:'win_pct' }}%; width: var(--league-win-pct);"></div>
                                                </div>
                                            </td>
                                        </tr>
                                         <!-- Draws -->
                                        <tr>
                                            <td class="text-start ps-3">% Draws</td>
                                            <td class="text-center"><span class="badge bg-warning text-dark">{{ stats|get_item:c|get_item:'draw_pct' }}%</span></td>
                                            <td class="text-center text-secondary">{{ league_avg|get_item:c|get_item:'draw_pct'|floatformat:0 }}%</td>
                                        </tr>
                                         <!-- Loss -->
                                        <tr>
                                            <td class="text-start ps-3">% Defeats</td>
                                            <td class="text-center"><span class="badge bg-danger">{{ stats|get_item:c|get_item:'loss_pct' }}%</span></td>
                                            <td class="text-center text-secondary">{{ league_avg|get_item:c|get_item:'loss_pct'|floatformat:0 }}%</td>
                                        </tr>
                                        <!-- Goals Scored -->
                                        <tr>
                                            <td class="text-start ps-3">Goals Scored / Match</td>
                                            <td class="text-center fw-bold text-success">{{ stats|get_item:c|get_item:'avg_gf' }}</td>
                                            <td class="text-center text-secondary">{{ league_avg|get_item:c|get_item:'avg_gf' }}</td>
                                        </tr>
                                         <!-- Goals Conceded -->
                                        <tr>
                                            <td class="text-start ps-3">Goals Conceded / Match</td>
                                            <td class="text-center fw-bold text-danger">{{ stats|get_item:c|get_item:'avg_ga' }}</td>
                                            <td class="text-center text-secondary">{{ league_avg|get_item:c|get_item:'avg_ga' }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- 6. Current Streaks -->
            <div class="card border-0 bg-white bg-opacity-10 text-white shadow-sm mb-4">
                 <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 py-2">
                    <h6 class="mb-0 fw-bold small text-uppercase">Current Streaks</h6>
                </div>
                <div class="card-body p-0">
                     <table class="table table-dark table-sm mb-0 text-center small">
                        <thead>
                            <tr class="text-secondary">
                                <th class="text-start ps-3">Sequence</th>
                                <th>Home</th>
                                <th>Away</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="text-start ps-3">Wins</td>
                                <td class="{% if streaks.home.win > 0 %}text-success fw-bold{% endif %}">{{ streaks.home.win }}</td>
                                <td class="{% if streaks.away.win > 0 %}text-success fw-bold{% endif %}">{{ streaks.away.win }}</td>
                                <td class="{% if streaks.total.win > 0 %}text-success fw-bold{% endif %}">{{ streaks.total.win }}</td>
                            </tr>
                            <tr>
                                <td class="text-start ps-3">Unbeaten (No Defeat)</td>
                                <td class="{% if streaks.home.no_defeat > 0 %}text-success fw-bold{% endif %}">{{ streaks.home.no_defeat }}</td>
                                <td class="{% if streaks.away.no_defeat > 0 %}text-success fw-bold{% endif %}">{{ streaks.away.no_defeat }}</td>
                                <td class="{% if streaks.total.no_defeat > 0 %}text-success fw-bold{% endif %}">{{ streaks.total.no_defeat }}</td>
                            </tr>
                            <tr>
                                <td class="text-start ps-3">Draws</td>
                                <td class="{% if streaks.home.draw > 0 %}text-warning fw-bold{% endif %}">{{ streaks.home.draw }}</td>
                                <td class="{% if streaks.away.draw > 0 %}text-warning fw-bold{% endif %}">{{ streaks.away.draw }}</td>
                                <td class="{% if streaks.total.draw > 0 %}text-warning fw-bold{% endif %}">{{ streaks.total.draw }}</td>
                            </tr>
                            <tr>
                                <td class="text-start ps-3">Defeats</td>
                                <td class="{% if streaks.home.loss > 0 %}text-danger fw-bold{% endif %}">{{ streaks.home.loss }}</td>
                                <td class="{% if streaks.away.loss > 0 %}text-danger fw-bold{% endif %}">{{ streaks.away.loss }}</td>
                                <td class="{% if streaks.total.loss > 0 %}text-danger fw-bold{% endif %}">{{ streaks.total.loss }}</td>
                            </tr>
                            <tr>
                                <td class="text-start ps-3">No Win</td>
                                <td class="{% if streaks.home.no_win > 0 %}text-danger fw-bold{% endif %}">{{ streaks.home.no_win }}</td>
                                <td class="{% if streaks.away.no_win > 0 %}text-danger fw-bold{% endif %}">{{ streaks.away.no_win }}</td>
                                <td class="{% if streaks.total.no_win > 0 %}text-danger fw-bold{% endif %}">{{ streaks.total.no_win }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 6.5. Run-In Difficulty -->
            <div class="card border-0 bg-white bg-opacity-10 text-white shadow-sm mb-4">
                <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 py-2">
                    <h6 class="mb-0 fw-bold small text-uppercase">Upcoming Opponents (Difficulty)</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-sm mb-0 text-center small align-middle">
                            <thead>
                                <tr class="text-secondary">
                                    <th class="text-start ps-3">Date</th>
                                    <th class="text-start">Opponent</th>
                                    <th>Venue</th>
                                    <th>Strength (PPG)</th>
                                    <th>Difficulty</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for m in run_in.matches %}
                                <tr>
                                    <td class="text-start ps-3 text-secondary">{{ m.match.date|date:"d/m" }}</td>
                                    <td class="text-start">
                                        <img src="{{ m.opponent.league.country|get_flag_url }}" alt="{{ m.opponent.league.country }}" style="height: 12px; margin-right: 4px;">
                                        {{ m.opponent.name }}
                                    </td>
                                    <td>
                                        {% if m.is_home %}
                                        <span class="badge bg-success bg-opacity-25 text-success">H</span>
                                        {% else %}
                                        <span class="badge bg-warning bg-opacity-25 text-warning">A</span>
                                        {% endif %}
                                    </td>
                                    <td>{% if m.is_home %}{{ m.col_away_ppg }}{% else %}{{ m.col_home_ppg }}{% endif %}</td>
                                    <td>
                                        <div class="progress" style="height: 6px; width: 60px; margin: 0 auto;">
                                            <div class="progress-bar 
                                                {% if m.opp_strength_pct < 33 %}bg-success
                                                {% elif m.opp_strength_pct < 66 %}bg-warning
                                                {% else %}bg-danger{% endif %}" 
                                                role="progressbar" 
                                                style="--opp-strength: {{ m.opp_strength_pct }}%; width: var(--opp-strength);">
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-secondary py-3">No matches scheduled.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="p-2 border-top border-secondary border-opacity-25 d-flex justify-content-around small">
                         <div>
                            <span class="text-secondary">Avg Opp (Home):</span>
                            <span class="fw-bold text-white">{{ run_in.avg_opp_ppg_home }}</span>
                         </div>
                         <div>
                            <span class="text-secondary">Avg Opp (Away):</span>
                            <span class="fw-bold text-white">{{ run_in.avg_opp_ppg_away }}</span>
                         </div>
                    </div>
                </div>
            </div>

            <!-- 7. Scoring & Conceding Rates -->
            <div class="card border-0 bg-white bg-opacity-10 text-white shadow-sm mb-4">
                <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 py-2">
                    <h6 class="mb-0 fw-bold small text-uppercase">Scoring & Conceding Rates</h6>
                </div>
                 <div class="card-body p-0">
                    <table class="table table-dark table-sm mb-0 text-center small">
                        <thead>
                             <tr class="text-secondary">
                                <th></th>
                                <th>Home</th>
                                <th>Away</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                             <tr>
                                <td class="text-start ps-3 text-success">Scoring Rate</td>
                                <td>{{ rates.home.scoring_rate_pct }}%</td>
                                <td>{{ rates.away.scoring_rate_pct }}%</td>
                                <td class="fw-bold">{{ rates.total.scoring_rate_pct }}%</td>
                            </tr>
                            <tr>
                                <td class="text-start ps-3 text-success">Scoring Rate 1st Half</td>
                                <td>{{ rates.home.score_1h_pct }}%</td>
                                <td>{{ rates.away.score_1h_pct }}%</td>
                                <td class="fw-bold">{{ rates.total.score_1h_pct }}%</td>
                            </tr>
                             <tr>
                                <td class="text-start ps-3 text-success">Scoring Rate 2nd Half</td>
                                <td>{{ rates.home.score_2h_pct }}%</td>
                                <td>{{ rates.away.score_2h_pct }}%</td>
                                <td class="fw-bold">{{ rates.total.score_2h_pct }}%</td>
                            </tr>
                             <tr>
                                <td class="text-start ps-3 text-success">Scored in Both Halves</td>
                                <td>{{ rates.home.score_both_pct }}%</td>
                                <td>{{ rates.away.score_both_pct }}%</td>
                                <td class="fw-bold">{{ rates.total.score_both_pct }}%</td>
                            </tr>
                             <tr class="bg-white bg-opacity-10">
                                <td class="text-start ps-3 text-warning">Both Teams Scored</td>
                                <td>{{ rates.home.bts_pct }}%</td>
                                <td>{{ rates.away.bts_pct }}%</td>
                                <td class="fw-bold">{{ rates.total.bts_pct }}%</td>
                            </tr>
                             <tr>
                                <td class="text-start ps-3 text-danger">Conceding Rate</td>
                                <td>{{ rates.home.conceding_rate_pct }}%</td>
                                <td>{{ rates.away.conceding_rate_pct }}%</td>
                                <td class="fw-bold">{{ rates.total.conceding_rate_pct }}%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 8. Timing of Goals -->
             <div class="card border-0 bg-white bg-opacity-10 text-white shadow-sm mb-4">
                <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 py-2">
                    <h6 class="mb-0 fw-bold small text-uppercase">Timing of Goals</h6>
                </div>
                 <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-sm mb-0 text-center small">
                            <thead>
                                <tr class="text-secondary">
                                    <th class="text-start ps-3">Period</th>
                                    <th>0-15</th>
                                    <th>16-30</th>
                                    <th>31-45</th>
                                    <th>46-60</th>
                                    <th>61-75</th>
                                    <th>76-90+</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="text-start ps-3 text-success">Scored</td>
                                    {% for c in timing_stats.scored.total %}
                                    <td>{{ c }}</td>
                                    {% endfor %}
                                </tr>
                                <tr>
                                    <td class="text-start ps-3 text-danger">Conceded</td>
                                    {% for c in timing_stats.conceded.total %}
                                    <td>{{ c }}</td>
                                    {% endfor %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>

        <!-- RIGHT COLUMN -->
        <div class="col-lg-4">
            
            <!-- 1. League Table Snippet (Results Table) -->
            <div class="card border-0 bg-white bg-opacity-10 text-white shadow-sm mb-4">
                 <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 py-2">
                    <h6 class="mb-0 fw-bold small text-uppercase">League Table</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-dark table-sm mb-0 text-center small align-middle">
                        <thead>
                            <tr class="text-secondary">
                                <th>#</th>
                                <th class="text-start">Team</th>
                                <th>GP</th>
                                <th>Pts</th>
                                <th>H</th>
                                <th>A</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for h in league_h2h %}
                            <tr class="{% if h.standing.team == team %}bg-primary bg-opacity-25{% endif %}">
                                <td class="text-secondary">{{ h.standing.position }}</td>
                                <td class="text-start">
                                    <a href="{% url 'matches:team_stats' league_name=league.name|slugify team_name=h.standing.team.name|slugify %}" class="text-decoration-none text-white">
                                        {{ h.standing.team.name }}
                                    </a>
                                </td>
                                <td class="text-secondary">{{ h.standing.played }}</td>
                                <td class="fw-bold">{{ h.standing.points }}</td>
                                <td>
                                    <span class="badge {{ h.home.bg }} text-dark p-1" style="min-width: 25px;">{{ h.home.score }}</span>
                                </td>
                                <td>
                                    <span class="badge {{ h.away.bg }} text-dark p-1" style="min-width: 25px;">{{ h.away.score }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 2. Goals Scored & Conceded -->
            <div class="card border-0 bg-white bg-opacity-10 text-white shadow-sm mb-4">
                <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 py-2">
                    <h6 class="mb-0 fw-bold small text-uppercase">Goals Scored & Conceded</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-dark table-sm mb-0 text-center small">
                         <thead>
                            <tr class="text-secondary">
                                <th></th>
                                <th>Home</th>
                                <th>Away</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                             <tr>
                                <td class="text-start ps-3 text-success">Goals For (GF)</td>
                                <td>{{ stats.home.gf }}</td>
                                <td>{{ stats.away.gf }}</td>
                                <td class="fw-bold">{{ stats.total.gf }}</td>
                            </tr>
                            <tr>
                                <td class="text-start ps-3">GF per match</td>
                                <td>{{ stats.home.avg_gf|floatformat:2 }}</td>
                                <td>{{ stats.away.avg_gf|floatformat:2 }}</td>
                                <td class="fw-bold">{{ stats.total.avg_gf|floatformat:2 }}</td>
                            </tr>
                             <tr>
                                <td class="text-start ps-3 text-danger">Goals Against (GA)</td>
                                <td>{{ stats.home.ga }}</td>
                                <td>{{ stats.away.ga }}</td>
                                <td class="fw-bold">{{ stats.total.ga }}</td>
                            </tr>
                            <tr>
                                <td class="text-start ps-3">GA per match</td>
                                <td>{{ stats.home.avg_ga|floatformat:2 }}</td>
                                <td>{{ stats.away.avg_ga|floatformat:2 }}</td>
                                <td class="fw-bold">{{ stats.total.avg_ga|floatformat:2 }}</td>
                            </tr>
                             <tr class="bg-white bg-opacity-10">
                                <td class="text-start ps-3">GF + GA per match</td>
                                <td>{{ stats.home.avg_total_goals|floatformat:2 }}</td>
                                <td>{{ stats.away.avg_total_goals|floatformat:2 }}</td>
                                <td class="fw-bold">{{ stats.total.avg_total_goals|floatformat:2 }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 3. Over / Under Stats -->
            <div class="card border-0 bg-white bg-opacity-10 text-white shadow-sm mb-4">
                 <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 py-2">
                    <h6 class="mb-0 fw-bold small text-uppercase">Match Total Goals Stats</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-dark table-sm mb-0 text-center small">
                        <thead>
                            <tr class="text-secondary">
                                <th class="text-start ps-3">Threshold</th>
                                <th>Home</th>
                                <th>Away</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for t in thresholds %}
                            <tr>
                                <td class="text-start ps-3">Over {{ t }} Goals</td>
                                <td>{{ goal_stats.match_total.home|get_key_pct:t }}%</td>
                                <td>{{ goal_stats.match_total.away|get_key_pct:t }}%</td>
                                <td class="fw-bold">{{ goal_stats.match_total.total|get_key_pct:t }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 4. Corners For -->
             <div class="card border-0 bg-white bg-opacity-10 text-white shadow-sm mb-4">
                 <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 py-2">
                    <h6 class="mb-0 fw-bold small text-uppercase">Total Corners (For)</h6>
                </div>
                <div class="card-body p-0">
                     <div class="table-responsive">
                        <table class="table table-dark table-sm mb-0 text-center small text-nowrap">
                            <thead>
                                <tr class="text-secondary">
                                    <th class="text-start ps-3"></th>
                                    <th>Avg</th>
                                    {% for t in corner_thresholds %}
                                    <th>{{ t }}+</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="text-start ps-3">Home</td>
                                    <td class="text-info">{{ corner_data.for.home.avg }}</td>
                                    {% for t in corner_thresholds %}
                                    <td>{{ corner_data.for.home.thresholds|get_item:t }}%</td>
                                    {% endfor %}
                                </tr>
                                 <tr>
                                    <td class="text-start ps-3">Away</td>
                                    <td class="text-info">{{ corner_data.for.away.avg }}</td>
                                    {% for t in corner_thresholds %}
                                    <td>{{ corner_data.for.away.thresholds|get_item:t }}%</td>
                                    {% endfor %}
                                </tr>
                                 <tr class="fw-bold bg-white bg-opacity-10">
                                    <td class="text-start ps-3">Total</td>
                                    <td class="text-info">{{ corner_data.for.total.avg }}</td>
                                    {% for t in corner_thresholds %}
                                    <td>{{ corner_data.for.total.thresholds|get_item:t }}%</td>
                                    {% endfor %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 5. Corners Against -->
             <div class="card border-0 bg-white bg-opacity-10 text-white shadow-sm mb-4">
                 <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 py-2">
                    <h6 class="mb-0 fw-bold small text-uppercase">Total Corners (Against)</h6>
                </div>
                <div class="card-body p-0">
                     <div class="table-responsive">
                        <table class="table table-dark table-sm mb-0 text-center small text-nowrap">
                            <thead>
                                <tr class="text-secondary">
                                    <th class="text-start ps-3"></th>
                                    <th>Avg</th>
                                    {% for t in corner_thresholds %}
                                    <th>{{ t }}+</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="text-start ps-3">Home</td>
                                    <td class="text-info">{{ corner_data.against.home.avg }}</td>
                                    {% for t in corner_thresholds %}
                                    <td>{{ corner_data.against.home.thresholds|get_item:t }}%</td>
                                    {% endfor %}
                                </tr>
                                 <tr>
                                    <td class="text-start ps-3">Away</td>
                                    <td class="text-info">{{ corner_data.against.away.avg }}</td>
                                    {% for t in corner_thresholds %}
                                    <td>{{ corner_data.against.away.thresholds|get_item:t }}%</td>
                                    {% endfor %}
                                </tr>
                                 <tr class="fw-bold bg-white bg-opacity-10">
                                    <td class="text-start ps-3">Total</td>
                                    <td class="text-info">{{ corner_data.against.total.avg }}</td>
                                    {% for t in corner_thresholds %}
                                    <td>{{ corner_data.against.total.thresholds|get_item:t }}%</td>
                                    {% endfor %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 6. Match Corners (Total) -->
             <div class="card border-0 bg-white bg-opacity-10 text-white shadow-sm mb-4">
                 <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 py-2">
                    <h6 class="mb-0 fw-bold small text-uppercase">Match Corners (Total)</h6>
                </div>
                <div class="card-body p-0">
                     <div class="table-responsive">
                        <table class="table table-dark table-sm mb-0 text-center small text-nowrap">
                            <thead>
                                <tr class="text-secondary">
                                    <th class="text-start ps-3"></th>
                                    <th>Avg</th>
                                    {% for t in corner_thresholds %}
                                    <th>{{ t }}+</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="text-start ps-3">Home</td>
                                    <td class="text-info">{{ corner_data.total.home.avg }}</td>
                                    {% for t in corner_thresholds %}
                                    <td>{{ corner_data.total.home.thresholds|get_item:t }}%</td>
                                    {% endfor %}
                                </tr>
                                 <tr>
                                    <td class="text-start ps-3">Away</td>
                                    <td class="text-info">{{ corner_data.total.away.avg }}</td>
                                    {% for t in corner_thresholds %}
                                    <td>{{ corner_data.total.away.thresholds|get_item:t }}%</td>
                                    {% endfor %}
                                </tr>
                                 <tr class="fw-bold bg-white bg-opacity-10">
                                    <td class="text-start ps-3">Total</td>
                                    <td class="text-info">{{ corner_data.total.total.avg }}</td>
                                    {% for t in corner_thresholds %}
                                    <td>{{ corner_data.total.total.thresholds|get_item:t }}%</td>
                                    {% endfor %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
             <!-- Cards -->
            <div class="card border-0 bg-white bg-opacity-10 text-white shadow-sm mb-4">
                 <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 py-2">
                    <h6 class="mb-0 fw-bold small text-uppercase">Cards</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-dark table-sm mb-0 text-center small">
                         <thead>
                            <tr class="text-secondary">
                                <th></th>
                                <th>Home</th>
                                <th>Away</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="text-start ps-3 text-warning">Yellow Cards</td>
                                <td>{{ card_stats.yellow.home }}</td>
                                <td>{{ card_stats.yellow.away }}</td>
                                <td class="fw-bold">{{ card_stats.yellow.total }}</td>
                            </tr>
                             <tr>
                                <td class="text-start ps-3 text-danger">Red Cards</td>
                                <td>{{ card_stats.red.home }}</td>
                                <td>{{ card_stats.red.away }}</td>
                                <td class="fw-bold">{{ card_stats.red.total }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('progressionChart');
        if (ctx) {
            const chartData = JSON.parse(ctx.dataset.chart);
            
            // Extract data
            const labels = chartData.map(d => d.round);
            const dataPoints = chartData.map(d => d.cumulative_points);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Points Progression',
                        data: dataPoints,
                        borderColor: '#0dcaf0', // Bootstrap info color
                        backgroundColor: 'rgba(13, 202, 240, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true,
                        pointBackgroundColor: '#0dcaf0'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#adb5bd' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#adb5bd' }
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}