{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetStats Pro | Analytics</title>

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Main Style -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <!-- Flag Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/7.1.0/css/flag-icons.min.css">
</head>

<body>

    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="brand">
            <i class="fa-solid fa-chart-simple"></i>
            <span>statsfut<span style="color:var(--primary)">.com</span></span>
        </div>

        <div class="menu-label">Main</div>
        <a href="/" class="nav-link active">
            <i class="fa-solid fa-house"></i> Dashboard
        </a>
        <!-- Live Page Removed per user request -->

        <a href="#" class="nav-link">
            <i class="fa-solid fa-star"></i> Favorites
        </a>

        <div class="menu-label">Countries & Leagues</div>
        
        <div class="accordion accordion-flush sidebar-accordion" id="accordionLeagues" style="max-height: 70vh; overflow-y: auto;">
            {% for country in sidebar_countries %}
            <div class="accordion-item bg-transparent border-0">
                <h2 class="accordion-header" id="heading{{ country.slug }}">
                    <button class="accordion-button collapsed bg-transparent text-white shadow-none px-3 py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ country.slug }}" aria-expanded="false" aria-controls="collapse{{ country.slug }}">
                        <span class="fi fi-{{ country.flag_code }} me-2"></span> {{ country.name }}
                    </button>
                </h2>
                <div id="collapse{{ country.slug }}" class="accordion-collapse collapse" aria-labelledby="heading{{ country.slug }}" data-bs-parent="#accordionLeagues">
                    <div class="accordion-body py-1 ps-4">
                        {% for league in country.leagues %}
                        <a href="{% url 'matches:country_league_stats' country.slug league.slug %}" class="nav-link-sub text-muted d-block py-1 text-decoration-none">{{ league.name }}</a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% empty %}
            <!-- Fallback if no leagues found in DB (e.g. during migration) -->
            <div class="px-3 py-2 text-muted small">Loading leagues...</div>
            {% endfor %}
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content">
        <!-- Top Header Bar -->
        <header class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom border-secondary border-opacity-25">
            <!-- Global Search -->
            <div class="position-relative w-50" style="max-width: 500px;">
                <div class="input-group">
                    <span class="input-group-text bg-dark border-secondary border-opacity-25 text-secondary border-end-0"><i class="fa-solid fa-magnifying-glass"></i></span>
                    <input type="text" id="global-search" class="form-control bg-dark border-secondary border-opacity-25 text-white shadow-none border-start-0" placeholder="Search teams, leagues..." autocomplete="off">
                    <span class="input-group-text bg-dark border-secondary border-opacity-25 text-secondary border-start-0 small" style="font-size: 0.75rem;">Ctrl+K</span>
                </div>
                <div id="search-results" class="list-group position-absolute mt-1 shadow-lg d-none w-100" style="z-index: 1050;"></div>
            </div>

            <!-- User / Date -->
            <div class="d-flex align-items-center gap-3">
                <div class="date-badge d-none d-md-inline-block">
                    <i class="fa-regular fa-clock me-1"></i> {% now "M d, Y, H:i" %}
                </div>
                <!-- Optional: User Profile or Settings could go here -->
            </div>
        </header>

        <!-- Country Flags Navigation -->
        <div class="d-flex flex-wrap gap-2 justify-content-center align-items-center p-3 mb-4 rounded shadow-sm" style="background: var(--bg-panel); border: 1px solid var(--border);">
            <a href="{% url 'matches:country_stats' 'argentina' %}" class="flag-btn" data-bs-toggle="tooltip" title="Argentina"><span class="fi fi-ar"></span></a>
            <a href="{% url 'matches:country_stats' 'austria' %}" class="flag-btn" data-bs-toggle="tooltip" title="Austria"><span class="fi fi-at"></span></a>
            <a href="{% url 'matches:country_stats' 'australia' %}" class="flag-btn" data-bs-toggle="tooltip" title="Australia"><span class="fi fi-au"></span></a>
            <a href="{% url 'matches:country_stats' 'belgium' %}" class="flag-btn" data-bs-toggle="tooltip" title="Belgium"><span class="fi fi-be"></span></a>
            <a href="{% url 'matches:country_stats' 'brazil' %}" class="flag-btn" data-bs-toggle="tooltip" title="Brazil"><span class="fi fi-br"></span></a>
            <a href="{% url 'matches:country_stats' 'switzerland' %}" class="flag-btn" data-bs-toggle="tooltip" title="Switzerland"><span class="fi fi-ch"></span></a>
            <a href="{% url 'matches:country_stats' 'germany' %}" class="flag-btn" data-bs-toggle="tooltip" title="Germany"><span class="fi fi-de"></span></a>
            <a href="{% url 'matches:country_stats' 'denmark' %}" class="flag-btn" data-bs-toggle="tooltip" title="Denmark"><span class="fi fi-dk"></span></a>
            <a href="{% url 'matches:country_stats' 'england' %}" class="flag-btn" data-bs-toggle="tooltip" title="England"><span class="fi fi-gb-eng"></span></a>
            <a href="{% url 'matches:country_stats' 'spain' %}" class="flag-btn" data-bs-toggle="tooltip" title="Spain"><span class="fi fi-es"></span></a>
            <a href="{% url 'matches:country_stats' 'finland' %}" class="flag-btn" data-bs-toggle="tooltip" title="Finland"><span class="fi fi-fi"></span></a>
            <a href="{% url 'matches:country_stats' 'france' %}" class="flag-btn" data-bs-toggle="tooltip" title="France"><span class="fi fi-fr"></span></a>
            <a href="{% url 'matches:country_stats' 'greece' %}" class="flag-btn" data-bs-toggle="tooltip" title="Greece"><span class="fi fi-gr"></span></a>
            <a href="{% url 'matches:country_stats' 'netherlands' %}" class="flag-btn" data-bs-toggle="tooltip" title="Netherlands"><span class="fi fi-nl"></span></a>
            <a href="{% url 'matches:country_stats' 'italy' %}" class="flag-btn" data-bs-toggle="tooltip" title="Italy"><span class="fi fi-it"></span></a>
            <a href="{% url 'matches:country_stats' 'japan' %}" class="flag-btn" data-bs-toggle="tooltip" title="Japan"><span class="fi fi-jp"></span></a>
            <a href="{% url 'matches:country_stats' 'norway' %}" class="flag-btn" data-bs-toggle="tooltip" title="Norway"><span class="fi fi-no"></span></a>
            <a href="{% url 'matches:country_stats' 'poland' %}" class="flag-btn" data-bs-toggle="tooltip" title="Poland"><span class="fi fi-pl"></span></a>
            <a href="{% url 'matches:country_stats' 'portugal' %}" class="flag-btn" data-bs-toggle="tooltip" title="Portugal"><span class="fi fi-pt"></span></a>
            <a href="{% url 'matches:country_stats' 'russia' %}" class="flag-btn" data-bs-toggle="tooltip" title="Russia"><span class="fi fi-ru"></span></a>
            <a href="{% url 'matches:country_stats' 'sweden' %}" class="flag-btn" data-bs-toggle="tooltip" title="Sweden"><span class="fi fi-se"></span></a>
            <a href="{% url 'matches:country_stats' 'turkey' %}" class="flag-btn" data-bs-toggle="tooltip" title="Turkey"><span class="fi fi-tr"></span></a>
            <a href="{% url 'matches:country_stats' 'ukraine' %}" class="flag-btn" data-bs-toggle="tooltip" title="Ukraine"><span class="fi fi-ua"></span></a>
        </div>

        <!-- Header & Banner Layout -->
        <div class="row align-items-center mb-4">
            <!-- Left: Page Title -->
            <div class="col-md-3">
                <div class="page-title">
                    {% block header %}
                    <h1 class="h3 mb-0 text-white">Overview</h1>
                    {% endblock %}
                </div>
            </div>

            <!-- Center: Banner -->
            <div class="col-md-6 text-center">
                <div class="ad-slot ad-slot-leaderboard mx-auto" style="margin-top: 0; margin-bottom: 0;">
                    Top banner â€“ 970x90 / 728x90 (or 320x100 mobile)
                </div>
            </div>

            <!-- Right: Date (Removed, moved to top header) -->
            <!-- <div class="col-md-3 text-md-end text-start mt-2 mt-md-0">
                <div class="date-badge d-inline-block">
                    <i class="fa-regular fa-clock me-1"></i> {% now "M d, Y, H:i" %}
                </div>
            </div> -->
        </div>

        {% block content %}{% endblock %}
    </main>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script>
        // Initialize Tooltips
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

        // Global Search Logic
        const searchInput = document.getElementById('global-search');
        const searchResults = document.getElementById('search-results');
        let debounceTimer;
        let activeIndex = -1; // Track active search result

        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                clearTimeout(debounceTimer);
                const query = e.target.value.trim();
                activeIndex = -1; // Reset active index on new input

                if (query.length < 2) {
                    searchResults.classList.add('d-none');
                    searchResults.innerHTML = '';
                    return;
                }

                debounceTimer = setTimeout(() => {
                    fetch(`/search/?q=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => {
                            searchResults.innerHTML = '';
                            if (data.results.length > 0) {
                                searchResults.classList.remove('d-none');
                                data.results.forEach((result, index) => {
                                    const item = document.createElement('a');
                                    item.href = result.url;
                                    item.className = 'list-group-item list-group-item-action bg-dark text-white border-secondary border-opacity-25 d-flex align-items-center gap-2 py-2 search-result-item';
                                    item.dataset.index = index;
                                    item.innerHTML = `
                                        <div class="d-flex align-items-center justify-content-center bg-secondary bg-opacity-10 rounded-circle" style="width: 30px; height: 30px;">
                                            <i class="fa-solid ${result.icon} text-info small"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold" style="font-size: 0.9rem;">${result.name}</div>
                                            <div class="text-secondary text-uppercase" style="font-size: 0.65rem; letter-spacing: 0.5px;">${result.type}</div>
                                        </div>
                                    `;
                                    // Add hover effect via JS to sync with keyboard nav
                                    item.addEventListener('mouseenter', () => {
                                        activeIndex = index;
                                        updateActiveItem();
                                    });
                                    searchResults.appendChild(item);
                                });
                            } else {
                                searchResults.classList.remove('d-none');
                                searchResults.innerHTML = '<div class="list-group-item bg-dark text-secondary border-secondary border-opacity-25 small py-2">No results found</div>';
                            }
                        })
                        .catch(err => console.error('Search error:', err));
                }, 300);
            });

            // Handle keyboard navigation
            searchInput.addEventListener('keydown', function(e) {
                const items = searchResults.querySelectorAll('.search-result-item');
                if (items.length === 0) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    activeIndex = (activeIndex + 1) % items.length;
                    updateActiveItem();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    activeIndex = (activeIndex - 1 + items.length) % items.length;
                    updateActiveItem();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (activeIndex >= 0 && items[activeIndex]) {
                        items[activeIndex].click();
                    }
                } else if (e.key === 'Escape') {
                    searchResults.classList.add('d-none');
                    searchInput.blur();
                }
            });

            function updateActiveItem() {
                const items = searchResults.querySelectorAll('.search-result-item');
                items.forEach((item, index) => {
                    if (index === activeIndex) {
                        item.classList.add('active', 'bg-primary', 'bg-opacity-25');
                        item.classList.remove('bg-dark');
                    } else {
                        item.classList.remove('active', 'bg-primary', 'bg-opacity-25');
                        item.classList.add('bg-dark');
                    }
                });
            }

            // Close search when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.add('d-none');
                }
            });

            // Keyboard shortcut (Ctrl/Cmd + K)
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    searchInput.focus();
                }
            });
        }
    </script>
</body>

</html>
